<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>CBT 챗봇</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        :root {
            --bg: #f6f7fb;
            --panel: #fff;
            --line: #e6e8ef;
            --assistant: #78a7ff;
            --user: #b7a8ff;
            --text: #1f2330;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            padding: 24px 16px;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif
        }

        .title {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            letter-spacing: .2px;
            color: #61646c;
            margin: 4px 0 14px
        }

        .divider {
            height: 1px;
            background: var(--line);
            margin: 6px 0 18px
        }

        .chat-card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            height: 65vh;
            min-height: 420px;
            display: flex;
            flex-direction: column;
            gap: 14px
        }

        .chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
            overflow-y: auto;
            overscroll-behavior: contain;
            scroll-behavior: smooth
        }

        .row {
            display: flex;
            width: 100%
        }

        .left {
            justify-content: flex-start
        }

        .right {
            justify-content: flex-end
        }

        .msg {
            max-width: 70%;
            background: #ddd;
            color: #fff;
            border-radius: 14px;
            padding: 12px 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: 0 1px 0 rgba(0, 0, 0, .06)
        }

        .left .msg {
            background: var(--assistant)
        }

        .right .msg {
            background: var(--user)
        }

        .composer {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: auto
        }

        .composer label {
            font-weight: 700
        }

        .composer input {
            flex: 1;
            height: 46px;
            padding: 10px 12px;
            font-size: 16px;
            border: 1px solid var(--line);
            border-radius: 10px;
            outline: none;
            background: #fff
        }

        .composer button {
            height: 46px;
            padding: 0 18px;
            font-size: 16px;
            font-weight: 700;
            border: 0;
            border-radius: 10px;
            cursor: pointer;
            background: #5d79ff;
            color: #fff
        }

        .summary {
            margin-top: 22px;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px
        }

        .summary h3,
        .summary h4 {
            margin: 12px 0 6px
        }

        /* 바깥 컨테이너: 플렉스 -> 그리드 */
        .page {
            display: grid;
            grid-template-columns: 280px minmax(720px, 960px) 1fr;
            /* 왼/가운데/오른쪽 */
            gap: 24px;
            align-items: start;
            /* 세 열 모두 윗선(top) 정렬 */
            padding: 24px 32px;
            box-sizing: border-box;
        }

        /* 열 배치 고정 */
        .notice {
            grid-column: 1;
            position: sticky;
            top: 96px;
        }

        .notice ul {
            padding-left: 20px;
            /* 글머리 기호 들여쓰기 */
            margin: 0;
            /* ul 자체 위아래 여백 초기화 */
        }

        .notice li {
            margin-bottom: 10px;
            /* 각 항목 사이 간격 */
            line-height: 1.5;
            /* 줄간격도 조금 넉넉하게 */
        }

        /* 마지막 li는 간격 없게 */
        .notice li:last-child {
            margin-bottom: 0;
        }

        .wrap {
            grid-column: 2;
            max-width: 960px;
            width: 100%;
            margin: 0;
        }

        /* ← margin-top 없게 */

        /* 기본 마진으로 생기는 위쪽 밀림 제거 */
        .notice h3,
        .wrap .title {
            margin-top: 0;
        }

        .typing {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        .subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
            margin-bottom: 8px;
            text-align: center;
        }

        .box-style {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 14px;
            background-color: #fafafa;
            line-height: 1.6;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .9);
            opacity: .3;
            animation: blink 1.2s infinite;
        }

        .dot:nth-child(2) {
            animation-delay: .2s;
        }

        .dot:nth-child(3) {
            animation-delay: .4s;
        }

        @keyframes blink {

            0%,
            80%,
            100% {
                opacity: .3
            }

            40% {
                opacity: 1
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <aside class="notice">
            <h3>📍 CBT 진행 시 주의사항</h3>
            <ul>
                <li><b>입력한 개인정보는 데이터 저장에 사용됩니다.</b> 정확하게 입력해주세요!</li>
                <li><b>"종료" 입력 시, 상담이 종료됩니다.</b> 상담이 끝나면 꼭 입력해주세요!</li>
                <li><b>"중단" 입력 시, 상담이 즉시 종료됩니다.</b> 상담을 다시 진행하고 싶거나, 금일 상담 내역 저장을 원치 않으면 입력해주세요! </li>
                <li>새로고침을 하거나 화면을 나가면, 상담 내역이 초기화됩니다. <b>현재 화면을 나가지 않게 조심해주세요!</b></li>
                <li>감정을 표현할 때는 자세하게 입력해주세요. <b>조금, 많이, 너무와 같은 감정의 강도를 나타내는 표현을 사용해보세요!</b></li>
                <li>
                    <b>자기평가 단계에서 순간적으로 떠오르는 부정적이거나 단정적인 생각을 표현해보세요. (예시 참고)</b>
                    <ul>
                        <li>나는 한심한 사람이다</li>
                        <li>나는 항상 실패한다</li>
                        <li>아무도 나를 좋아하지 않는다</li>
                    </ul>
                </li>
                <li><b>응답은 자세할수록 좋아요. 오늘을 돌아보고 마음을 솔직하게 적어주세요.</b></li>
            </ul>
        </aside>

        <div class="wrap">
            <div class="title">스마트 모니터 CBT</div>
            <div class="subtitle">🖥️💬 생각과 감정을 점검하고 긍정적인 변화를 돕는 인지 상담 온라인 서비스입니다. 상담을 시작해보세요!</div>
            <div class="divider"></div>

            <div class="chat-card">
                <ul class="chat-list" id="chatList">
                    {# ✅ 히스토리만 그대로 렌더 (system 제외된 튜플(role, text)) #}
                    {% for role, text in history %}
                    <li class="row {{ 'right' if role == 'user' else 'left' }}">
                        <div class="msg">{{ text }}</div>
                    </li>
                    {% endfor %}
                </ul>

                <form method="POST" class="composer" id="composer">
                    <label for="user_input">입력</label>
                    <input id="user_input" name="user_input" placeholder="당신의 응답을 입력하세요." autocomplete="off">
                    <button type="submit">전송</button>
                </form>
            </div>

            {% if event %}
            <div class="summary" id="summaryBox">
                <h3>📌 CBT 결과 요약 리포트</h3>

                {% if event %}
                <h4>📝 상담 배경 상황(주요 사건 요약)</h4>
                <p class="box-style">{{ event }}</p>
                {% endif %}

                {% if emotion %}
                <h4>📊 상담 전후 감정 비교</h4>
                <p class="box-style">{{ emotion }}</p>
                {% endif %}

                {% if auto %}
                <h4>🗯️ 자동적 사고 정리</h4>
                <p class="box-style">{{ auto }}</p>
                {% endif %}

                {% if distortion %}
                <h4>🧠 인지 왜곡 패턴 분석</h4>
                <p class="box-style">{{ distortion }}</p>
                {% endif %}

                {% if alternative %}
                <h4>🗨️ 대안적 사고 제공</h4>
                <p class="box-style">{{ alternative }}</p>
                {% endif %}

                {% if plan %}
                <h4>📄 추천 실천 방법</h4>
                <p class="box-style">{{ plan }}</p>
                {% endif %}

                {% if goal %}
                <h4>☑️ 개선 목표</h4>
                <p class="box-style">{{ goal }}</p>
                {% endif %}

            </div>
            {% endif %}
        </div>
    </div>

    <script>
        const list = document.getElementById('chatList');
        const form = document.getElementById('composer');
        const input = document.getElementById('user_input');

        function scrollToBottom() { if (list) list.scrollTop = list.scrollHeight; }
        scrollToBottom();

        // 말풍선 도우미
        function appendBubble(side, html) {
            const li = document.createElement('li');
            li.className = `row ${side === 'user' ? 'right' : 'left'}`;
            const msg = document.createElement('div');
            msg.className = 'msg';
            msg.innerHTML = html;
            li.appendChild(msg);
            list.appendChild(li);
            scrollToBottom();
            return li;
        }
        function appendTypingBubble() {
            return appendBubble('assistant', `<div class="typing">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>`);
        }
        function replaceBubbleContent(li, text) {
            const msg = li.querySelector('.msg');
            if (msg) { msg.textContent = text; scrollToBottom(); }
        }

        // ✅ 새로 추가: 응답 HTML에서 #summaryBox 가져와 현재 페이지에 반영
        function syncSummaryFromDoc(doc) {
            const incoming = doc.getElementById('summaryBox');   // 응답에 요약이 있으면 존재
            if (!incoming) return;                                // 일반 대화면 없음 → 그대로 둠
            const cloned = document.importNode(incoming, true);  // 다른 문서의 노드이므로 import

            const current = document.getElementById('summaryBox');
            if (current) {
                current.replaceWith(cloned);                       // 기존 요약 교체
            } else {
                const wrap = document.querySelector('.wrap');
                const chatCard = wrap?.querySelector('.chat-card');
                if (chatCard) {
                    chatCard.insertAdjacentElement('afterend', cloned); // 채팅 카드 아래에 삽입
                } else {
                    wrap?.appendChild(cloned);
                }
            }
        }

        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;

            // 1) 내 말풍선 즉시
            appendBubble('user', text);
            // 2) 로딩 말풍선
            const typingLi = appendTypingBubble();

            try {
                // 3) 기존 "/"로 POST (백엔드 변경 없음)
                const resp = await fetch(window.location.pathname, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ user_input: text })
                });
                const html = await resp.text();

                // 4) 응답 HTML에서 마지막 assistant 말풍선 추출 → 교체
                const doc = new DOMParser().parseFromString(html, "text/html");
                const msgs = doc.querySelectorAll("#chatList .row.left .msg");
                if (msgs.length) {
                    const last = msgs[msgs.length - 1].textContent || "";
                    replaceBubbleContent(typingLi, last);
                } else {
                    replaceBubbleContent(typingLi, "(응답 없음)");
                }

                // ✅ 5) 요약/감정/왜곡 섹션 동기화
                syncSummaryFromDoc(doc);

            } catch (err) {
                replaceBubbleContent(typingLi, "(오류가 발생했습니다)");
            } finally {
                input.value = "";
                input.focus();
            }
        });

        // 새로고침 시 GET으로 초기화 유지
        window.history.replaceState({}, "", "{{ url_for('cbt_server.index') }}");
    </script>

</body>

</html>