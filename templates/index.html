<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>CBT ì±—ë´‡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        :root {
            --bg: #f6f7fb;
            --panel: #fff;
            --line: #e6e8ef;
            --assistant: #78a7ff;
            --user: #b7a8ff;
            --text: #1f2330;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            padding: 24px 16px;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif
        }

        .title {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            letter-spacing: .2px;
            color: #61646c;
            margin: 4px 0 14px
        }

        .divider {
            height: 1px;
            background: var(--line);
            margin: 6px 0 18px
        }

        .chat-card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            height: 65vh;
            min-height: 420px;
            display: flex;
            flex-direction: column;
            gap: 14px
        }

        .chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
            overflow-y: auto;
            overscroll-behavior: contain;
            scroll-behavior: smooth
        }

        .row {
            display: flex;
            width: 100%
        }

        .left {
            justify-content: flex-start
        }

        .right {
            justify-content: flex-end
        }

        .msg {
            max-width: 70%;
            background: #ddd;
            color: #fff;
            border-radius: 14px;
            padding: 12px 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: 0 1px 0 rgba(0, 0, 0, .06)
        }

        .left .msg {
            background: var(--assistant)
        }

        .right .msg {
            background: var(--user)
        }

        .composer {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: auto
        }

        .composer label {
            font-weight: 700
        }

        .composer input {
            flex: 1;
            height: 46px;
            padding: 10px 12px;
            font-size: 16px;
            border: 1px solid var(--line);
            border-radius: 10px;
            outline: none;
            background: #fff
        }

        .composer button {
            height: 46px;
            padding: 0 18px;
            font-size: 16px;
            font-weight: 700;
            border: 0;
            border-radius: 10px;
            cursor: pointer;
            background: #5d79ff;
            color: #fff
        }

        .summary {
            margin-top: 22px;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px
        }

        .summary h3,
        .summary h4 {
            margin: 12px 0 6px
        }

        /* ë°”ê¹¥ ì»¨í…Œì´ë„ˆ: í”Œë ‰ìŠ¤ -> ê·¸ë¦¬ë“œ */
        .page {
            display: grid;
            grid-template-columns: 280px minmax(720px, 960px) 1fr;
            /* ì™¼/ê°€ìš´ë°/ì˜¤ë¥¸ìª½ */
            gap: 24px;
            align-items: start;
            /* ì„¸ ì—´ ëª¨ë‘ ìœ—ì„ (top) ì •ë ¬ */
            padding: 24px 32px;
            box-sizing: border-box;
        }

        /* ì—´ ë°°ì¹˜ ê³ ì • */
        .notice {
            grid-column: 1;
            position: sticky;
            top: 96px;
        }

        .notice ul {
            padding-left: 20px;
            /* ê¸€ë¨¸ë¦¬ ê¸°í˜¸ ë“¤ì—¬ì“°ê¸° */
            margin: 0;
            /* ul ìì²´ ìœ„ì•„ë˜ ì—¬ë°± ì´ˆê¸°í™” */
        }

        .notice li {
            margin-bottom: 10px;
            /* ê° í•­ëª© ì‚¬ì´ ê°„ê²© */
            line-height: 1.5;
            /* ì¤„ê°„ê²©ë„ ì¡°ê¸ˆ ë„‰ë„‰í•˜ê²Œ */
        }

        /* ë§ˆì§€ë§‰ liëŠ” ê°„ê²© ì—†ê²Œ */
        .notice li:last-child {
            margin-bottom: 0;
        }

        .wrap {
            grid-column: 2;
            max-width: 960px;
            width: 100%;
            margin: 0;
        }

        /* â† margin-top ì—†ê²Œ */

        /* ê¸°ë³¸ ë§ˆì§„ìœ¼ë¡œ ìƒê¸°ëŠ” ìœ„ìª½ ë°€ë¦¼ ì œê±° */
        .notice h3,
        .wrap .title {
            margin-top: 0;
        }

        .typing {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        .subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
            margin-bottom: 8px;
            text-align: center;
        }

        .box-style {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 14px;
            background-color: #fafafa;
            line-height: 1.6;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .9);
            opacity: .3;
            animation: blink 1.2s infinite;
        }

        .dot:nth-child(2) {
            animation-delay: .2s;
        }

        .dot:nth-child(3) {
            animation-delay: .4s;
        }

        @keyframes blink {

            0%,
            80%,
            100% {
                opacity: .3
            }

            40% {
                opacity: 1
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <aside class="notice">
            <h3>ğŸ“ CBT ì§„í–‰ ì‹œ ì£¼ì˜ì‚¬í•­</h3>
            <ul>
                <li><b>ì…ë ¥í•œ ê°œì¸ì •ë³´ëŠ” ë°ì´í„° ì €ì¥ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</b> ì •í™•í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”!</li>
                <li><b>"ì¢…ë£Œ" ì…ë ¥ ì‹œ, ìƒë‹´ì´ ì¢…ë£Œë©ë‹ˆë‹¤.</b> ìƒë‹´ì´ ëë‚˜ë©´ ê¼­ ì…ë ¥í•´ì£¼ì„¸ìš”!</li>
                <li><b>"ì¤‘ë‹¨" ì…ë ¥ ì‹œ, ìƒë‹´ì´ ì¦‰ì‹œ ì¢…ë£Œë©ë‹ˆë‹¤.</b> ìƒë‹´ì„ ë‹¤ì‹œ ì§„í–‰í•˜ê³  ì‹¶ê±°ë‚˜, ê¸ˆì¼ ìƒë‹´ ë‚´ì—­ ì €ì¥ì„ ì›ì¹˜ ì•Šìœ¼ë©´ ì…ë ¥í•´ì£¼ì„¸ìš”! </li>
                <li>ìƒˆë¡œê³ ì¹¨ì„ í•˜ê±°ë‚˜ í™”ë©´ì„ ë‚˜ê°€ë©´, ìƒë‹´ ë‚´ì—­ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. <b>í˜„ì¬ í™”ë©´ì„ ë‚˜ê°€ì§€ ì•Šê²Œ ì¡°ì‹¬í•´ì£¼ì„¸ìš”!</b></li>
                <li>ê°ì •ì„ í‘œí˜„í•  ë•ŒëŠ” ìì„¸í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. <b>ì¡°ê¸ˆ, ë§ì´, ë„ˆë¬´ì™€ ê°™ì€ ê°ì •ì˜ ê°•ë„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í‘œí˜„ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”!</b></li>
                <li>
                    <b>ìê¸°í‰ê°€ ë‹¨ê³„ì—ì„œ ìˆœê°„ì ìœ¼ë¡œ ë– ì˜¤ë¥´ëŠ” ë¶€ì •ì ì´ê±°ë‚˜ ë‹¨ì •ì ì¸ ìƒê°ì„ í‘œí˜„í•´ë³´ì„¸ìš”. (ì˜ˆì‹œ ì°¸ê³ )</b>
                    <ul>
                        <li>ë‚˜ëŠ” í•œì‹¬í•œ ì‚¬ëŒì´ë‹¤</li>
                        <li>ë‚˜ëŠ” í•­ìƒ ì‹¤íŒ¨í•œë‹¤</li>
                        <li>ì•„ë¬´ë„ ë‚˜ë¥¼ ì¢‹ì•„í•˜ì§€ ì•ŠëŠ”ë‹¤</li>
                    </ul>
                </li>
                <li><b>ì‘ë‹µì€ ìì„¸í• ìˆ˜ë¡ ì¢‹ì•„ìš”. ì˜¤ëŠ˜ì„ ëŒì•„ë³´ê³  ë§ˆìŒì„ ì†”ì§í•˜ê²Œ ì ì–´ì£¼ì„¸ìš”.</b></li>
            </ul>
        </aside>

        <div class="wrap">
            <div class="title">ìŠ¤ë§ˆíŠ¸ ëª¨ë‹ˆí„° CBT</div>
            <div class="subtitle">ğŸ–¥ï¸ğŸ’¬ ìƒê°ê³¼ ê°ì •ì„ ì ê²€í•˜ê³  ê¸ì •ì ì¸ ë³€í™”ë¥¼ ë•ëŠ” ì¸ì§€ ìƒë‹´ ì˜¨ë¼ì¸ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ìƒë‹´ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
            <div class="divider"></div>

            <div class="chat-card">
                <ul class="chat-list" id="chatList">
                    {# âœ… íˆìŠ¤í† ë¦¬ë§Œ ê·¸ëŒ€ë¡œ ë Œë” (system ì œì™¸ëœ íŠœí”Œ(role, text)) #}
                    {% for role, text in history %}
                    <li class="row {{ 'right' if role == 'user' else 'left' }}">
                        <div class="msg">{{ text }}</div>
                    </li>
                    {% endfor %}
                </ul>

                <form method="POST" class="composer" id="composer">
                    <label for="user_input">ì…ë ¥</label>
                    <input id="user_input" name="user_input" placeholder="ë‹¹ì‹ ì˜ ì‘ë‹µì„ ì…ë ¥í•˜ì„¸ìš”." autocomplete="off">
                    <button type="submit">ì „ì†¡</button>
                </form>
            </div>

            {% if event %}
            <div class="summary" id="summaryBox">
                <h3>ğŸ“Œ CBT ê²°ê³¼ ìš”ì•½ ë¦¬í¬íŠ¸</h3>

                {% if event %}
                <h4>ğŸ“ ìƒë‹´ ë°°ê²½ ìƒí™©(ì£¼ìš” ì‚¬ê±´ ìš”ì•½)</h4>
                <p class="box-style">{{ event }}</p>
                {% endif %}

                {% if emotion %}
                <h4>ğŸ“Š ìƒë‹´ ì „í›„ ê°ì • ë¹„êµ</h4>
                <p class="box-style">{{ emotion }}</p>
                {% endif %}

                {% if auto %}
                <h4>ğŸ—¯ï¸ ìë™ì  ì‚¬ê³  ì •ë¦¬</h4>
                <p class="box-style">{{ auto }}</p>
                {% endif %}

                {% if distortion %}
                <h4>ğŸ§  ì¸ì§€ ì™œê³¡ íŒ¨í„´ ë¶„ì„</h4>
                <p class="box-style">{{ distortion }}</p>
                {% endif %}

                {% if alternative %}
                <h4>ğŸ—¨ï¸ ëŒ€ì•ˆì  ì‚¬ê³  ì œê³µ</h4>
                <p class="box-style">{{ alternative }}</p>
                {% endif %}

                {% if plan %}
                <h4>ğŸ“„ ì¶”ì²œ ì‹¤ì²œ ë°©ë²•</h4>
                <p class="box-style">{{ plan }}</p>
                {% endif %}

                {% if goal %}
                <h4>â˜‘ï¸ ê°œì„  ëª©í‘œ</h4>
                <p class="box-style">{{ goal }}</p>
                {% endif %}

            </div>
            {% endif %}
        </div>
    </div>

    <script>
        const list = document.getElementById('chatList');
        const form = document.getElementById('composer');
        const input = document.getElementById('user_input');

        function scrollToBottom() { if (list) list.scrollTop = list.scrollHeight; }
        scrollToBottom();

        // ë§í’ì„  ë„ìš°ë¯¸
        function appendBubble(side, html) {
            const li = document.createElement('li');
            li.className = `row ${side === 'user' ? 'right' : 'left'}`;
            const msg = document.createElement('div');
            msg.className = 'msg';
            msg.innerHTML = html;
            li.appendChild(msg);
            list.appendChild(li);
            scrollToBottom();
            return li;
        }
        function appendTypingBubble() {
            return appendBubble('assistant', `<div class="typing">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>`);
        }
        function replaceBubbleContent(li, text) {
            const msg = li.querySelector('.msg');
            if (msg) { msg.textContent = text; scrollToBottom(); }
        }

        // âœ… ìƒˆë¡œ ì¶”ê°€: ì‘ë‹µ HTMLì—ì„œ #summaryBox ê°€ì ¸ì™€ í˜„ì¬ í˜ì´ì§€ì— ë°˜ì˜
        function syncSummaryFromDoc(doc) {
            const incoming = doc.getElementById('summaryBox');   // ì‘ë‹µì— ìš”ì•½ì´ ìˆìœ¼ë©´ ì¡´ì¬
            if (!incoming) return;                                // ì¼ë°˜ ëŒ€í™”ë©´ ì—†ìŒ â†’ ê·¸ëŒ€ë¡œ ë‘ 
            const cloned = document.importNode(incoming, true);  // ë‹¤ë¥¸ ë¬¸ì„œì˜ ë…¸ë“œì´ë¯€ë¡œ import

            const current = document.getElementById('summaryBox');
            if (current) {
                current.replaceWith(cloned);                       // ê¸°ì¡´ ìš”ì•½ êµì²´
            } else {
                const wrap = document.querySelector('.wrap');
                const chatCard = wrap?.querySelector('.chat-card');
                if (chatCard) {
                    chatCard.insertAdjacentElement('afterend', cloned); // ì±„íŒ… ì¹´ë“œ ì•„ë˜ì— ì‚½ì…
                } else {
                    wrap?.appendChild(cloned);
                }
            }
        }

        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;

            // 1) ë‚´ ë§í’ì„  ì¦‰ì‹œ
            appendBubble('user', text);
            // 2) ë¡œë”© ë§í’ì„ 
            const typingLi = appendTypingBubble();

            try {
                // 3) ê¸°ì¡´ "/"ë¡œ POST (ë°±ì—”ë“œ ë³€ê²½ ì—†ìŒ)
                const resp = await fetch(window.location.pathname, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ user_input: text })
                });
                const html = await resp.text();

                // 4) ì‘ë‹µ HTMLì—ì„œ ë§ˆì§€ë§‰ assistant ë§í’ì„  ì¶”ì¶œ â†’ êµì²´
                const doc = new DOMParser().parseFromString(html, "text/html");
                const msgs = doc.querySelectorAll("#chatList .row.left .msg");
                if (msgs.length) {
                    const last = msgs[msgs.length - 1].textContent || "";
                    replaceBubbleContent(typingLi, last);
                } else {
                    replaceBubbleContent(typingLi, "(ì‘ë‹µ ì—†ìŒ)");
                }

                // âœ… 5) ìš”ì•½/ê°ì •/ì™œê³¡ ì„¹ì…˜ ë™ê¸°í™”
                syncSummaryFromDoc(doc);

            } catch (err) {
                replaceBubbleContent(typingLi, "(ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤)");
            } finally {
                input.value = "";
                input.focus();
            }
        });

        // ìƒˆë¡œê³ ì¹¨ ì‹œ GETìœ¼ë¡œ ì´ˆê¸°í™” ìœ ì§€
        window.history.replaceState({}, "", "{{ url_for('cbt_server.index') }}");
    </script>

</body>

</html>